### 6.1 웹 중개자
- 프락시는 클라이언트와 서버를 매개하는 또 다른 HTTP 웹 서버다.
- 클라이언트 관점에서는 프락시가 서버다.
- 프락시는 클라이언트 요청에 대한 적절한 응답을 한다.
- 프락시는 클라이언트 요청을 적절히 처리하여 서버에 넘긴다.
- 프락시는 클라이언트, 서버 양 쪽과 통신하므로 양 쪽의 규칙을 모두 잘 따라야 한다.
- 프락시에는 개인 프락시, 공용 프락시가 있다. 
- 개인 프락시는 클라이언트에서 직접 실행되는 형태로 사용되며, 클라이언트 한 군데만을 위한 프락시를 말한다.
- 대부분의 프락시가 공용으로, 특히 캐시 프록시같은 경우 사용자가 많을 수록 공통된 요청을 처리하는 데 효율적이다.

**프락시 대 게이트웨이**
- 차이는 둘 이상의 같은 프로토콜을 사용하는 애플리케이션을 연결하느냐, 다른 프로토콜을 사용하는 애플리케이션을 연결하느냐다.
- 전자는 프락시, 후자는 게이트웨이
> 게이트웨이는 클라이언트와 서버가 서로 다른 프로토콜로 말하더라도 서로 간의 트랜잭션을 완료할 수 있도록 해주는 프로토콜 변환기처럼 동작한다.(p149)
- 하지만 완전히 구분되는 것은 아니다. 상용 프락시 서버는 SSL 보안 프로토콜, 방화벽, FTP 접근 등을 위해 게이트웨이 기능(프로토콜 변환)을 갖고 있다.

**언제 사용하는가**
- 성인 콘텐츠 차단
- 문서 접근 제어 : 중앙 프락시 서버가 권한별로 문서에 대한 접근을 제어할 수 있다.
- 보안 방화벽 : 조직 내외부에서 통신하는 응용 레벨 프로토콜의 흐름을 통제하거나, 트래픽을 검사하기 위한 훅을 제공하는 프락시 서버를 사용한다.
- 웹 캐시 : 멀리 있는 리소스 대신, 로컬에 리소스 사본을 저장해두는 프락시 서버 기능
- 대리 프락시 : 웹 서버처럼 보이지만, 리소스 위치를 찾기 위해 다른 서버와 통신한다. 
- 콘텐츠 라우터 : 트래픽과 콘텐츠 종류에 따라 특정 웹서버로 유도할 때 사용한다. 예) 비과금 고객이 콘텐츠를 요청하면 로컬 캐시로 전달, 과금 고객이면 원 서버로 전달
- 트랜스코더 : 응답 콘텐츠를 클라이언트에 전달하기 전에 변형시킨다. 확장자, 이미지 크기, 텍스트 압축, 기기에 맞게 조정된 웹 페이지, 국제화 등
- 익명화 프락시 : HTTP에서 신원을 식별하게끔 하는 값들을 제거하여 개인정보를 보호하는 장점, 하지만 사용자 브라우징 경험이 저하될 수도 있다.

> - User-Agent 헤더에서 사용자의 컴퓨터와 OS 종류를 제거한다.<br>
> - 사용자의 이메일 주소를 보호하기 위해 From 헤더는 제거된다.<br>
> - 어떤 사이트를 거쳐서 방문했는지 알기 어렵게 하기 위해 Referer 헤더는 제거된다.<br>
> - 프로필과 신원 정보를 없애기 위해 Cookie 헤더는 제거된다 (p155)
 
**프락시는 어디에 있는가**
1. 로컬 네트워크의 출구
2. ISP 입구 : 인터넷 대역폭 비용을 줄이기 위해 캐시 프락시를 앞에 둔다.
3. 웹 서버들의 바로 앞 : 대리 프락시. 웬만한 요청은 대리로 처리하고, 필요한 요청만 웹 서버에 넘긴다. 웹 서버와 IP 주소를 가장한다.
4. 네트워크 사이 : 트래픽 흐름을 감시하고 혼잡을 환화하기 위해 인터넷 피어링 교환 지점에 놓인다.

**프락시 계층**
- 연쇄적으로 연결된 프락시 계층에서 프락시들은 부모 자식 관계를 갖는다.
- 흐름이 꼭 정적인 것은 아니다. 요청의 상황에 맞게 동적으로 부모를 선택한다.(부하 균형, 지리적 인접성, 프로토콜/요청 타입, 유료 서비스 가입자 등에 따라)

**어떻게 프락시가 트래픽을 처리하는가**
- 프락시 설정이 자동으로 되어 있다면, 웹 클라이언트(브라우저)의 요청은 프락시를 타게 된다.
- 프락시 호스트와 포트를 직접 수동 설정할 수도 있다.
- 인터셉트 프락시는 클라이언트가 알지 못하는 상태에서 트래픽을 프락시로 보내는 스위칭, 라우팅 장치를 포함한다.
- 대리 프락시는 웹 서버의 이름과 IP 주소를 가장하므로, 대신 트래픽을 처리한다.
- 리다이렉션 코드를 반환함으로써 요청을 프락시로 리다이렉트할 수 있다.

### 6.5 프락시 요청의 미묘한 특징들
- 클라이언트가 웹 서버가 아닌 프락시에 요청할 때에는 요청줄에서 스킴, 호스트, 포트번호가 포함된 완전한 URI를 확인할 수 있다.
- 웹 서버로 바로 요청할 때에는 위 세 가지가 생략된 부분 URI를 갖는 이유는, 이미 서버가 자신의 호스트명과 포트 번호를 알고 있기 때문이다.
- 특히 웹 서버가 가상 호스팅되고 있을 경우, 여러 웹 사이트가 같은 물리적 서버를 공유하므로 완전한 URI를 알아야 요청이 가능하다.
- 하지만 대리 프락시일 경우, 프락시가 원 서버의 호스트명과 IP주소를 대리하기 때문에 부분 URI를 보내지 않는다.
- 인터셉트 프락시의 경우에도, 이미 클라이언트에서 서버로 가는 요청을 가로채기 때문에 원 서버로 보내는 부분 URI를 얻게 된다.
- 완전 URI와 부분 URI를 사용하는 규칙은 다음과 같다.(p167)
> - 완전한 URI가 주어졌다면, 프락시는 그것을 사용해야 한다.<br>
> - 부분 URI가 주어졌고 Host 헤더가 있다면, 이를 이용해 호스트명과 포트 번호를 알아내야 한다.<br>
 - 부분 URI가 있지만 Host 헤더가 없다면, 대리 프락시인지 혹은 인터셉트 프락시가 가로챈 트래픽인 지 확인 후 IP 주소와 포트번호를 확인한다.
 - 위 경우에 해당하지 않으면 에러를 반환하여 Host 헤더를 포함하도록 해야 한다.
 
 **클라이언트 자동확장과 호스트명 분석** 
 - 브라우저는 프락시가 없을 경우 사용자가 입력한 URI을 기준으로 그에 맞는 IP주소를 찾는다.
 - 맞는 호스트가 발견되지 않으면, 약어를 입력했다고 보고 자동화된 '확장'을 사용한 몇 가지 시도를 한다.
 - 예를 들어, 'google'을 입력했다면 'www.google.com'으로 접두사와 접미사를 붙이는 식의.
 - 대부분의 시스템에서 사용자가 입력한 URI를 교정하거나 보완하여 도메인을 검색하도록 설정돼있다.
 - 명시적 프락시를 사용한다면 자동확장의 장점을 누릴 수 없다.
 - 인터셉트 프락시를 사용한다면, 클라이언트 입장에서 프락시는 없는 것이기 때문에 동작 자체는 원 서버에 요청할 때와 별 차이가 없다.
 - 그러나, DNS 서버에서 호스트명과 매치되는 IP 주소 목록을 갖게 된 클라이언트는, 프락시로 '죽어있는 서버'에 요청할 경우 프락시가 커넥션을 끊었음에도 원 서버에서 끊었다고 여긴다.
 - 명시적 프락시던 인터셉트 프락시던, 살아있는 서버에 접근할 수 있도록(호스트명을 다시 분석하거나, 역방향 DNS 룩업 등을 통해) 조치할 수 있어야 한다.

### 6.6 메시지 추적
- 캐시 프락시 서버를 사용하는 경우는 매우 흔하다. 
- 프락시를 개발하는 벤더들이 있고, 서로 다른 기능과 버그를 갖고 있으므로 이를 넘나드는 메시지를 추적하고 문제를 발견하는 것도 중요한 일이 됐다.
- Via 헤더는 클라이언트 요청 시 중간에 거치는 프락시나 게이트웨이 정보를 추가하기 위한 필드다. 
- 예를 들어 `Via: 1.1 proxy-62.irenes-isp.net, 1.0 cache.joes-hhardware.com`일 경우 HTTP/1.1, 1.0을 각각 구현한 두 개의 프락시를 거쳤다는 의미.
- 몇몇 프락시는 게이트웨이 기능을 지니는데, 서버 응답 시 프로토콜 변환에 대한 정보가 Via 헤더에 추가된다.

**TRACE 메서드**
- HTTP/1.1의 TRACE 메서드는 요청 시 프락시 체인을 따라가면서 메시지를 추적 관찰하는 데 유용하다.
- 원 서버로부터 TRACE 응답이 도착하면, 어떤 프락시를 거쳤는지를 원 서버 응답과 함께 검사할 수 있다.

### 6.7 프락시 인증
- 프락시는 접근 허가에 필요한 정보를 407 Proxy Authorization Required 상태코드, Proxy-Authenticate 헤더와 함께 반환할 수 있다
- 하지만 프락시 인증은 프락시 여러 개가 체이닝되어 있을 경우 잘 동작하지 않으며, 널리 구현되지는 않았다.

### 6.8 프락시 상호운용성
- 서로 다른 벤더에 의해 만들어지는 클라이언트, 서버, 프락시 간의 상호운용성을 위해서 프락시는 메서드 확장을 이용해 지원하지 않는 메서드를 다룬다
- 클아이언트에서 OPTIONS 메서드를 통해 원 서버에서 어떤 메서드를 지원하는 지 미리 알아볼 수도 있다.
