### 17.1 내용 협상 기법(p458)
예) 'http://www.joes-hardware.com'을 프랑스어, 영어로 서비스하고 있다면 서버는 사용자마다 어떤 버전을 제공해주어야 되는가? 
내용 협상 기법은 클라이언트의 지역화된 요청에 최적화된 콘텐츠를 요청하고 응답하는 방법을 다룬다.

1. 클라이언트 주도
  - 클라이언트가 요청하면, 서버가 선택지를 주고, 클라이언트가 고르는 기법.
  - 장점 : 서버 입장에서 구현하기 가장 쉽고, 클라이언트는 최선의 선택을 할 수 있다.
  - 단점 : 대기 시간이 증가한다. 즉, 올바른 콘텐츠를 얻으려면 최소 두 번의 요청이 필요하다.
2. 서버 주도
  - 서버가 클라이언트의 요청 헤더를 검증해서 어떤 버전을 제공할지 결정한다.
  - 클라이언트 주도 협상보다 빠르다. HTTP는 서버가 가장 적절한 것을 선택할 수 있도록 q값 메커니즘을 제공하고, 서버가 다운스트림 장치에게 요청이 어떻게 평가되는지 말해줄 수 있도록 하기 위해 Vary 헤더를 사용한다.
  - 단점 : 만약 결정이 뻔하지 않으면(헤더에 맞는 것이 없으면) 서버는 추측해야 한다.
3. 투명
  - 투명한 중간 장치(주로 프락시 캐시)가 서버를 대신하여 협상을 한다.
  - 웹 서버가 협상할 필요 없고, 클라이언트 주도 협상보다 빠르다.
  - 단점: 정형화된 명세가 없다.
 
 ### 17.2 클라이언트 주도 협상
 - 무조건 요청이 두 번은 가야한다는 게 단점이다. 그리고 URL도 여러 개 필요하다. 
 - 클라이언트가 요청하면, 서버가 가능한 페이지 목록을 보내주고, 클라이언트가 그 중 선택하여 요청하면 서버가 페이지 사본을 전달해주는 방식.
 - 서버는 목록을 전달할 때 버전에 대한 링크와 설명이 포함된 HTML 페이지를 돌려주거나, 300 Multiple Choices 응답 코드를 반환한다.
 
 ### 17.3 서버 주도 협상
 - 서버가 알아서 최적화된 페이지를 고르게 하려면, 클라이언트가 서버에게 미리 충분한 정보를 요청 헤더에 전달해야 한다.
 - HTTP 서버는 먼저 클라이언트의 Accept 관련 헤더를 살펴본 다음, 그 외 다른 헤더(User-Agent)를 참고하여 적절한 응답을 계산한다.
 - 내용 협상 헤더에는 이런 것들이 있다.
    - `Accept` : 서버가 어떤 미디어 타입으로 보내도 되는지 알려준다
    - `Accept-Language` : 서버가 어떤 언어로 보내도 되는지 알려준다
    - `Accept-Charset` : 서버가 어떤 차셋으로 보내도 되는지 알려준다
    - `Accept-Encoding` : 서버가 어떤 인코딩으로 보내도 되는지 알려준다
    
  - HTTP는 무상태 프로토콜이므로 클라이언트는 매번 자신의 선호 정보를 요청에 포함시켜야 한다. 
  - 보다 풍부한 선호도에 대한 정보를 포함시키려면, 품질값을 헤더에 더하는 방법이 있다.
  `Accept-Language: en;q=0.5, fr;q=0.0, nl;q=1.0, tr;q=0.0`
  - 클라이언트는 q값을 0.0부터 1.0까지 매김으로써 서버가 선호에 대응하는 문서를 찾는 것을 돕는다.
  - `User-Agent` 헤더를 참고해 오래된 브라우저가 지원하지 않는 특정 스크립트가 포함되지 않는 페이지를 전달하도록 할 수도 있다.
  - `Vary` 헤더는 서버가 응답 시 어떤 요청 헤더를 참고했는지 캐시나 클라이언트, 다운스트림 프락시에게 전달하는 역할을 한다.
  
  ### 17.4 투명 협상
  > 클라이언트 입장에서 협상하는 중개자 프락시를 둠으로써 클라이언트와의 메시지 교환을 최소화하는 동시에 서버 주도 협상으로 인한 부하를 제거한다. (p463)
  > 캐시 프락시는 단일한 URL을 통해 접근할 수 있는 문서의 여러 다른 사본을 저장할 수 있다. (p464)
  - 캐시는 요청에 대한 첫 번째 응답과 두 번째 응답을 모두 저장해야 한다. 결국 같은 URL에 대해 여러 버전의 문서를 갖게 되고, 내용 협상은 이 중 클라이언트의 요청에 가장 잘 부합하는 것을 선택하는 과정이다.
  > 캐시된 배리언트(variant)와 클라이언트 요청 헤더, 그에 알맞은 서버 응답 헤더 모두를 저장해야 한다. (p464)
  > 서버가 특정 요청 헤더에 따라 다르게 응답한다면, 캐시된 응답을 돌려보내기 전에 반드시 일반적인 내용 협상 헤더 뿐 아니라 이들 요청 헤더들도 맞춰봐야 한다. (p465)
  
  ### 17.5 트랜스코딩
  - 서버가 클라이언트의 요구에 맞는 문서를 갖고 있지 않을 경우, 기존 문서를 요구에 맞게 변환해야 하는데 이를 트랜스코딩이라고 한다.
  - 트랜스코딩에는 포맷 변환, 정보 합성, 콘텐츠 주입 세 가지가 있다.
  - 포맷 변환 : 특정 클라이언트가 볼 수 있도록 포맷을 변환하는 것이다. 내용 협상 헤더를 참고한다.
  - 정보 합성 : 문서에서 요점을 추출하는 것으로, 포털 웹 디렉터리같은 자동화된 분류 시스템에 종종 사용된다.
  - 콘텐츠 주입 : 자동 광고 생성과 사용자 추적 시스템에 사용된다. 타겟 광고를 페이지에 삽입하거나, 사용자의 웹 이용 통계 수집을 위해 동적으로 콘텐츠가 추가된다.
  - 트랜스코딩의 대안은 웹페이지의 사본을 여러 개 만드는 것이지만, 각기 요청에 항상 부합하는 페이지를 제공하는 웹 서버를 프로그래밍할 수는 없다. 
  - 특히 타깃 광고는 정적인 프로그래밍으로는 어렵다. 그래서 루트 페이지를 트랜스코딩하는 것이고, 대안으로 프락시나 외부 에이전트에 트랜스코딩을 맡김으로써 웹 서버의 부담을 덜 수 있다.
  
  
